{% extends "tracker/base.html" %}
{% block title %}Dashboard - Tax Tracker{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
  <p class="mt-1 text-sm text-gray-500">Portfolio overview and quick stats.</p>
</div>

<!-- Stats cards - row 1 -->
<div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-6">
  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Holdings</dt>
            <dd class="text-lg font-semibold text-gray-900">{{ holdings_count }} securities</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Cost Base</dt>
            <dd class="text-lg font-semibold text-gray-900">${{ total_cost_base|floatformat:2 }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 {% if total_realised >= 0 %}text-green-400{% else %}text-red-400{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Net Realised Gain</dt>
            <dd class="text-lg font-semibold {% if total_realised >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
              ${{ total_realised|floatformat:2 }}
            </dd>
          </dl>
        </div>
      </div>
    </div>
    <div class="bg-gray-50 px-5 py-3">
      <a href="{% url 'tracker:cgt_summary' %}" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
        View CGT report &rarr;
      </a>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 {% if unmatched_sells > 0 %}text-red-400{% else %}text-green-400{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Unmatched Sells</dt>
            <dd class="text-lg font-semibold {% if unmatched_sells > 0 %}text-red-600{% else %}text-green-600{% endif %}">
              {{ unmatched_sells }}
            </dd>
          </dl>
        </div>
      </div>
    </div>
    {% if unmatched_sells > 0 %}
    <div class="bg-gray-50 px-5 py-3">
      <a href="{% url 'tracker:unmatched_sells' %}" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
        Match now &rarr;
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Stats cards - row 2 -->
<div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5-3L16.5 18m0 0L12 13.5m4.5 4.5V4.5"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Transactions</dt>
            <dd class="text-lg font-semibold text-gray-900">{{ total_transactions }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Parcels</dt>
            <dd class="text-lg font-semibold text-gray-900">{{ total_parcels }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Gross Realised</dt>
            <dd class="text-lg font-semibold {% if total_gross >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
              ${{ total_gross|floatformat:2 }}
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 14.25l-3-3m0 0l3-3m-3 3h10.5"/>
          </svg>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">CGT Discounts</dt>
            <dd class="text-lg font-semibold text-blue-600">${{ total_discounts|floatformat:2 }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-8">
  <!-- Top Holdings -->
  {% if top_holdings %}
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex items-center justify-between">
      <h2 class="text-lg font-medium text-gray-900">Top Holdings</h2>
      <span class="text-xs text-gray-400">by cost base</span>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Security</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Held</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Base</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for h in top_holdings %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              <a href="{% url 'tracker:parcel_list' %}?security={{ h.security__ticker }}" class="text-indigo-600 hover:text-indigo-500">
                {{ h.security__ticker }}
              </a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
              {{ h.effective_remaining|floatformat:2 }}
              {% if h.pending_sell_qty > 0 %}
              <span class="text-xs text-amber-500" title="Pending unmatched sells">({{ h.pending_sell_qty|floatformat:2 }} pending sale)</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${{ h.total_cost_base|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="bg-gray-50 px-5 py-3 border-t">
      <a href="{% url 'tracker:parcel_list' %}" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
        View all parcels &rarr;
      </a>
    </div>
  </div>
  {% endif %}

  <!-- Recent Activity -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
      <h2 class="text-lg font-medium text-gray-900">Recent Activity</h2>
    </div>
    <div class="divide-y divide-gray-200">
      {% if recent_matches %}
      <div class="px-4 py-3">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Latest Matches</h3>
        <ul class="space-y-2">
          {% for m in recent_matches %}
          <li class="flex items-center justify-between text-sm">
            <span class="text-gray-700">
              {{ m.matched_quantity|floatformat:2 }} {{ m.parcel.security.ticker }}
              <span class="text-gray-400">matched</span>
            </span>
            <span class="font-medium {% if m.net_capital_gain >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
              ${{ m.net_capital_gain|floatformat:2 }}
            </span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if recent_imports %}
      <div class="px-4 py-3">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Latest Imports</h3>
        <ul class="space-y-2">
          {% for imp in recent_imports %}
          <li class="flex items-center justify-between text-sm">
            <span class="text-gray-700 truncate max-w-xs">{{ imp.filename }}</span>
            <span class="text-gray-400 text-xs">{{ imp.imported_at|date:"d M Y H:i" }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if not recent_matches and not recent_imports %}
      <div class="px-4 py-8 text-center">
        <p class="text-sm text-gray-500">No activity yet. Start by importing a CSV file.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- All Holdings table -->
{% if holdings %}
<div class="bg-white shadow rounded-lg">
  <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900">All Current Holdings</h2>
    <p class="mt-1 text-xs text-gray-400">Reflects unmatched sells as pending. Units shown are your effective position.</p>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Security</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Parcel Remaining</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Pending Sells</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Effective Held</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Base (AUD)</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for h in holdings %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
            <a href="{% url 'tracker:parcel_list' %}?security={{ h.security__ticker }}" class="text-indigo-600 hover:text-indigo-500">
              {{ h.security__ticker }}
            </a>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">{{ h.parcel_remaining|floatformat:2 }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
            {% if h.pending_sell_qty > 0 %}
            <span class="text-amber-600">-{{ h.pending_sell_qty|floatformat:2 }}</span>
            {% else %}
            <span class="text-gray-400">--</span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right">{{ h.effective_remaining|floatformat:2 }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${{ h.total_cost_base|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="text-center py-12 bg-white shadow rounded-lg">
  <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
  </svg>
  <h3 class="mt-2 text-sm font-semibold text-gray-900">No holdings yet</h3>
  <p class="mt-1 text-sm text-gray-500">Get started by importing a CSV file.</p>
  <div class="mt-6">
    <a href="{% url 'tracker:csv_upload' %}" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
      Import CSV
    </a>
  </div>
</div>
{% endif %}

<!-- Quick links -->
<div class="mt-8 grid grid-cols-1 gap-4 sm:grid-cols-3">
  <a href="{% url 'tracker:csv_upload' %}"
     class="relative block rounded-lg border border-gray-300 bg-white px-6 py-4 shadow-sm hover:border-indigo-400 hover:ring-1 hover:ring-indigo-400">
    <span class="text-sm font-medium text-gray-900">Import CSV</span>
    <span class="mt-1 block text-sm text-gray-500">Upload SelfWealth or generic CSV files</span>
  </a>
  <a href="{% url 'tracker:forecast' %}"
     class="relative block rounded-lg border border-gray-300 bg-white px-6 py-4 shadow-sm hover:border-indigo-400 hover:ring-1 hover:ring-indigo-400">
    <span class="text-sm font-medium text-gray-900">CGT Forecast</span>
    <span class="mt-1 block text-sm text-gray-500">Simulate sells and compare strategies</span>
  </a>
  <a href="{% url 'tracker:cgt_summary' %}"
     class="relative block rounded-lg border border-gray-300 bg-white px-6 py-4 shadow-sm hover:border-indigo-400 hover:ring-1 hover:ring-indigo-400">
    <span class="text-sm font-medium text-gray-900">CGT Report</span>
    <span class="mt-1 block text-sm text-gray-500">View capital gains by financial year</span>
  </a>
</div>
{% endblock %}
