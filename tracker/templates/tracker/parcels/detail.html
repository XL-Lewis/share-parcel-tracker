{% extends "tracker/base.html" %}
{% block title %}Parcel #{{ parcel.pk }} - Tax Tracker{% endblock %}

{% block content %}
<div class="mb-6">
  <a href="{% url 'tracker:parcel_list' %}" class="text-indigo-600 hover:text-indigo-500 text-sm">&larr; Back to Parcels</a>
  <h1 class="mt-3 text-2xl font-bold text-gray-900">
    Parcel #{{ parcel.pk }} &mdash; {{ parcel.security.ticker }}
    {% if parcel.is_fully_matched %}
    <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-green-100 text-green-800 ml-2">Fully Matched</span>
    {% else %}
    <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 ml-2">{{ parcel.remaining_quantity }} remaining</span>
    {% endif %}
  </h1>
</div>

<!-- Acquisition info -->
<div class="bg-white shadow rounded-lg mb-6">
  <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900">Acquisition Details</h2>
  </div>
  <div class="px-4 py-5 sm:px-6">
    <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-3">
      <div>
        <dt class="text-sm font-medium text-gray-500">Security</dt>
        <dd class="mt-1 text-sm text-gray-900 font-semibold">{{ parcel.security.ticker }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Acquisition Date</dt>
        <dd class="mt-1 text-sm text-gray-900">{{ parcel.acquisition_date }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Original Quantity</dt>
        <dd class="mt-1 text-sm text-gray-900">{{ parcel.original_quantity }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Remaining Quantity</dt>
        <dd class="mt-1 text-sm text-gray-900 font-semibold">{{ parcel.remaining_quantity }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Cost Per Unit (AUD)</dt>
        <dd class="mt-1 text-sm text-gray-900">${{ parcel.cost_per_unit_aud|floatformat:4 }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Total Cost Base (AUD)</dt>
        <dd class="mt-1 text-sm text-gray-900 font-semibold">${{ parcel.total_cost_base_aud|floatformat:2 }}</dd>
      </div>
    </dl>
    <div class="mt-4">
      <a href="{% url 'tracker:transaction_detail' parcel.transaction.pk %}" class="text-sm text-indigo-600 hover:text-indigo-500">
        View Buy Transaction &rarr;
      </a>
    </div>
  </div>
</div>

<!-- Matches -->
{% if matches %}
<div class="bg-white shadow rounded-lg">
  <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
    <h2 class="text-lg font-medium text-gray-900">Matches ({{ matches|length }})</h2>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sell Date</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Matched Qty</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cost Base</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Proceeds</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Gain/Loss</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Holding Days</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Discount</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Net Gain</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for m in matches %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 whitespace-nowrap">
            <a href="{% url 'tracker:transaction_detail' m.sell_transaction.pk %}" class="text-indigo-600 hover:text-indigo-500">
              {{ m.sell_transaction.trade_date }}
            </a>
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-right">{{ m.matched_quantity }}</td>
          <td class="px-4 py-3 whitespace-nowrap text-right">${{ m.cost_base_aud|floatformat:2 }}</td>
          <td class="px-4 py-3 whitespace-nowrap text-right">${{ m.proceeds_aud|floatformat:2 }}</td>
          <td class="px-4 py-3 whitespace-nowrap text-right {% if m.capital_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
            ${{ m.capital_gain_loss|floatformat:2 }}
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-right">{{ m.holding_period_days }}</td>
          <td class="px-4 py-3 whitespace-nowrap text-center">
            {% if m.cgt_discount_eligible %}
            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800">50%</span>
            {% else %}
            <span class="text-gray-400">-</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-right font-medium {% if m.net_capital_gain >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
            ${{ m.net_capital_gain|floatformat:2 }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="bg-white shadow rounded-lg p-6 text-center text-gray-500">
  No matches yet for this parcel.
</div>
{% endif %}
{% endblock %}
