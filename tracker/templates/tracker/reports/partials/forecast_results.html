{% if errors %}
<div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
  <h3 class="text-sm font-medium text-red-800">Could not run forecast:</h3>
  <ul class="mt-2 list-disc list-inside text-sm text-red-700">
    {% for error in errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{% if result %}
<div class="mb-4">
  <h2 class="text-lg font-medium text-gray-900">
    Forecast: Sell {{ result.quantity|floatformat:2 }} {{ result.security.ticker }}
    @ ${{ result.sell_price|floatformat:2 }} on {{ result.sell_date|date:"j M Y" }}
  </h2>
</div>

<!-- Strategy comparison cards -->
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3 mb-8">
  {% with strategies="fifo,lifo,optimal" %}
  {% for strategy_name in strategies|make_list %}
  {% endfor %}
  {% endwith %}

  <!-- FIFO -->
  {% with strat=result.fifo label="FIFO" desc="First In, First Out" color="blue" %}
  <div class="bg-white shadow rounded-lg overflow-hidden border-t-4 border-{{ color }}-500">
    <div class="px-4 py-5 sm:px-6 bg-{{ color }}-50">
      <h3 class="text-base font-semibold text-{{ color }}-900">{{ label }}</h3>
      <p class="text-xs text-{{ color }}-700">{{ desc }} -- oldest parcels sold first</p>
    </div>
    <div class="p-4 space-y-3">
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Total Proceeds</span>
        <span class="font-medium">${{ strat.total_proceeds|floatformat:2 }}</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Total Cost Base</span>
        <span class="font-medium">${{ strat.total_cost_base|floatformat:2 }}</span>
      </div>
      <div class="border-t pt-3 flex justify-between text-sm">
        <span class="text-gray-500">Gross Gain/Loss</span>
        <span class="font-medium {% if strat.total_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
          ${{ strat.total_gain_loss|floatformat:2 }}
        </span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">CGT Discount</span>
        <span class="font-medium text-blue-600">${{ strat.total_discount|floatformat:2 }}</span>
      </div>
      <div class="border-t pt-3 flex justify-between text-sm font-semibold">
        <span class="text-gray-700">Net Capital Gain</span>
        <span class="{% if strat.total_net_gain >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
          ${{ strat.total_net_gain|floatformat:2 }}
        </span>
      </div>
    </div>

    {% if strat.parcels_consumed %}
    <div class="border-t">
      <details class="group">
        <summary class="px-4 py-3 text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50">
          Parcel breakdown ({{ strat.parcels_consumed|length }})
        </summary>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-gray-500">Acquired</th>
                <th class="px-3 py-2 text-right text-gray-500">Qty</th>
                <th class="px-3 py-2 text-right text-gray-500">Days</th>
                <th class="px-3 py-2 text-right text-gray-500">Gain/Loss</th>
                <th class="px-3 py-2 text-center text-gray-500">Disc.</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for p in strat.parcels_consumed %}
              <tr>
                <td class="px-3 py-2 text-gray-900">{{ p.acquisition_date|date:"d/m/Y" }}</td>
                <td class="px-3 py-2 text-right text-gray-900">{{ p.matched_quantity|floatformat:2 }}</td>
                <td class="px-3 py-2 text-right text-gray-500">{{ p.holding_period_days }}</td>
                <td class="px-3 py-2 text-right {% if p.capital_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                  ${{ p.capital_gain_loss|floatformat:2 }}
                </td>
                <td class="px-3 py-2 text-center">
                  {% if p.cgt_discount_eligible %}
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                  {% else %}
                  <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">No</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>
    {% endif %}
  </div>
  {% endwith %}

  <!-- LIFO -->
  {% with strat=result.lifo label="LIFO" desc="Last In, First Out" color="amber" %}
  <div class="bg-white shadow rounded-lg overflow-hidden border-t-4 border-amber-500">
    <div class="px-4 py-5 sm:px-6 bg-amber-50">
      <h3 class="text-base font-semibold text-amber-900">{{ label }}</h3>
      <p class="text-xs text-amber-700">{{ desc }} -- newest parcels sold first</p>
    </div>
    <div class="p-4 space-y-3">
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Total Proceeds</span>
        <span class="font-medium">${{ strat.total_proceeds|floatformat:2 }}</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Total Cost Base</span>
        <span class="font-medium">${{ strat.total_cost_base|floatformat:2 }}</span>
      </div>
      <div class="border-t pt-3 flex justify-between text-sm">
        <span class="text-gray-500">Gross Gain/Loss</span>
        <span class="font-medium {% if strat.total_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
          ${{ strat.total_gain_loss|floatformat:2 }}
        </span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">CGT Discount</span>
        <span class="font-medium text-blue-600">${{ strat.total_discount|floatformat:2 }}</span>
      </div>
      <div class="border-t pt-3 flex justify-between text-sm font-semibold">
        <span class="text-gray-700">Net Capital Gain</span>
        <span class="{% if strat.total_net_gain >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
          ${{ strat.total_net_gain|floatformat:2 }}
        </span>
      </div>
    </div>

    {% if strat.parcels_consumed %}
    <div class="border-t">
      <details class="group">
        <summary class="px-4 py-3 text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50">
          Parcel breakdown ({{ strat.parcels_consumed|length }})
        </summary>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-gray-500">Acquired</th>
                <th class="px-3 py-2 text-right text-gray-500">Qty</th>
                <th class="px-3 py-2 text-right text-gray-500">Days</th>
                <th class="px-3 py-2 text-right text-gray-500">Gain/Loss</th>
                <th class="px-3 py-2 text-center text-gray-500">Disc.</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for p in strat.parcels_consumed %}
              <tr>
                <td class="px-3 py-2 text-gray-900">{{ p.acquisition_date|date:"d/m/Y" }}</td>
                <td class="px-3 py-2 text-right text-gray-900">{{ p.matched_quantity|floatformat:2 }}</td>
                <td class="px-3 py-2 text-right text-gray-500">{{ p.holding_period_days }}</td>
                <td class="px-3 py-2 text-right {% if p.capital_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                  ${{ p.capital_gain_loss|floatformat:2 }}
                </td>
                <td class="px-3 py-2 text-center">
                  {% if p.cgt_discount_eligible %}
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                  {% else %}
                  <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">No</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>
    {% endif %}
  </div>
  {% endwith %}

  <!-- Optimal -->
  {% with strat=result.optimal label="Optimal" desc="Highest Cost First" color="emerald" %}
  <div class="bg-white shadow rounded-lg overflow-hidden border-t-4 border-emerald-500">
    <div class="px-4 py-5 sm:px-6 bg-emerald-50">
      <h3 class="text-base font-semibold text-emerald-900">{{ label }}</h3>
      <p class="text-xs text-emerald-700">{{ desc }} -- minimises capital gain</p>
    </div>
    <div class="p-4 space-y-3">
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Total Proceeds</span>
        <span class="font-medium">${{ strat.total_proceeds|floatformat:2 }}</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Total Cost Base</span>
        <span class="font-medium">${{ strat.total_cost_base|floatformat:2 }}</span>
      </div>
      <div class="border-t pt-3 flex justify-between text-sm">
        <span class="text-gray-500">Gross Gain/Loss</span>
        <span class="font-medium {% if strat.total_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
          ${{ strat.total_gain_loss|floatformat:2 }}
        </span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">CGT Discount</span>
        <span class="font-medium text-blue-600">${{ strat.total_discount|floatformat:2 }}</span>
      </div>
      <div class="border-t pt-3 flex justify-between text-sm font-semibold">
        <span class="text-gray-700">Net Capital Gain</span>
        <span class="{% if strat.total_net_gain >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
          ${{ strat.total_net_gain|floatformat:2 }}
        </span>
      </div>
    </div>

    {% if strat.parcels_consumed %}
    <div class="border-t">
      <details class="group">
        <summary class="px-4 py-3 text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50">
          Parcel breakdown ({{ strat.parcels_consumed|length }})
        </summary>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-gray-500">Acquired</th>
                <th class="px-3 py-2 text-right text-gray-500">Qty</th>
                <th class="px-3 py-2 text-right text-gray-500">Days</th>
                <th class="px-3 py-2 text-right text-gray-500">Gain/Loss</th>
                <th class="px-3 py-2 text-center text-gray-500">Disc.</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for p in strat.parcels_consumed %}
              <tr>
                <td class="px-3 py-2 text-gray-900">{{ p.acquisition_date|date:"d/m/Y" }}</td>
                <td class="px-3 py-2 text-right text-gray-900">{{ p.matched_quantity|floatformat:2 }}</td>
                <td class="px-3 py-2 text-right text-gray-500">{{ p.holding_period_days }}</td>
                <td class="px-3 py-2 text-right {% if p.capital_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                  ${{ p.capital_gain_loss|floatformat:2 }}
                </td>
                <td class="px-3 py-2 text-center">
                  {% if p.cgt_discount_eligible %}
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                  {% else %}
                  <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">No</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>
    {% endif %}
  </div>
  {% endwith %}
</div>

<!-- Savings highlight -->
{% if result.fifo.total_net_gain != result.optimal.total_net_gain %}
<div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
  <div class="flex">
    <div class="flex-shrink-0">
      <svg class="h-5 w-5 text-emerald-400" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
      </svg>
    </div>
    <div class="ml-3">
      <h3 class="text-sm font-medium text-emerald-800">Potential Savings with Optimal Strategy</h3>
      <div class="mt-1 text-sm text-emerald-700">
        <p>
          Using the optimal strategy instead of FIFO could
          {% if result.optimal.total_net_gain < result.fifo.total_net_gain %}
            <strong>reduce</strong> your net capital gain by
            <strong>${{ result.fifo.total_net_gain|floatformat:2 }} - ${{ result.optimal.total_net_gain|floatformat:2 }}</strong>.
          {% else %}
            result in the same or higher gain. FIFO may be the better choice for this sell.
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endif %}
